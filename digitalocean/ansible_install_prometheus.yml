---
- name: Install Prometheus and Node Exporter on DigitalOcean droplets
  hosts: os_servers
  become: yes
  gather_facts: yes
  vars:
    prometheus_version: "3.9.1"
    node_exporter_version: "1.10.2"
    prometheus_user: "prometheus"
    prometheus_group: "prometheus"
    prometheus_dir: "/etc/prometheus"
    prometheus_data_dir: "/var/lib/prometheus"
    prometheus_log_dir: "/var/log/prometheus"
    node_exporter_user: "node_exporter"
    node_exporter_group: "node_exporter"
    supported_debian_family: "Debian"
    supported_redhat_family: "RedHat"

  tasks:
    # ==========================================
    # Prerequisites (All OS)
    # ==========================================
    - name: Create Prometheus system group
      group:
        name: "{{ prometheus_group }}"
        system: yes
        state: present

    - name: Create Prometheus system user
      user:
        name: "{{ prometheus_user }}"
        group: "{{ prometheus_group }}"
        system: yes
        shell: /sbin/nologin
        createhome: no
        state: present

    - name: Create Node Exporter system group
      group:
        name: "{{ node_exporter_group }}"
        system: yes
        state: present

    - name: Create Node Exporter system user
      user:
        name: "{{ node_exporter_user }}"
        group: "{{ node_exporter_group }}"
        system: yes
        shell: /sbin/nologin
        createhome: no
        state: present

    # ==========================================
    # Install Required Packages
    # ==========================================
    - name: "[Debian/Ubuntu] Install required packages"
      apt:
        name:
          - curl
          - tar
          - wget
          - gnupg2
        state: present
        update_cache: yes
      when: ansible_os_family == supported_debian_family

    - name: "[RedHat] Install required packages"
      yum:
        name:
          - curl
          - tar
          - wget
        state: present
      when: ansible_os_family == supported_redhat_family

    # ==========================================
    # Download and Install Prometheus
    # ==========================================
    - name: Create Prometheus directories
      file:
        path: "{{ item }}"
        state: directory
        owner: "{{ prometheus_user }}"
        group: "{{ prometheus_group }}"
        mode: '0755'
      loop:
        - "{{ prometheus_dir }}"
        - "{{ prometheus_dir }}/consoles"
        - "{{ prometheus_dir }}/console_libraries"
        - "{{ prometheus_data_dir }}"
        - "{{ prometheus_log_dir }}"

    - name: Check if Prometheus is already installed
      stat:
        path: /usr/local/bin/prometheus
      register: prometheus_binary

    - name: Download Prometheus
      get_url:
        url: "https://github.com/prometheus/prometheus/releases/download/v{{ prometheus_version }}/prometheus-{{ prometheus_version }}.linux-amd64.tar.gz"
        dest: "/tmp/prometheus-{{ prometheus_version }}.linux-amd64.tar.gz"
        mode: '0644'
      when: not prometheus_binary.stat.exists

    - name: Extract Prometheus
      unarchive:
        src: "/tmp/prometheus-{{ prometheus_version }}.linux-amd64.tar.gz"
        dest: "/tmp"
        remote_src: yes
      when: not prometheus_binary.stat.exists

    - name: Copy Prometheus binaries
      copy:
        src: "/tmp/prometheus-{{ prometheus_version }}.linux-amd64/{{ item }}"
        dest: "/usr/local/bin/{{ item }}"
        owner: "{{ prometheus_user }}"
        group: "{{ prometheus_group }}"
        mode: '0755'
        remote_src: yes
      loop:
        - prometheus
        - promtool
      when: not prometheus_binary.stat.exists

    - name: Copy Prometheus console files
      copy:
        src: "/tmp/prometheus-{{ prometheus_version }}.linux-amd64/{{ item }}/"
        dest: "{{ prometheus_dir }}/{{ item }}/"
        owner: "{{ prometheus_user }}"
        group: "{{ prometheus_group }}"
        remote_src: yes
      loop:
        - consoles
        - console_libraries
      when: not prometheus_binary.stat.exists

    - name: Create Prometheus configuration file
      copy:
        dest: "{{ prometheus_dir }}/prometheus.yml"
        owner: "{{ prometheus_user }}"
        group: "{{ prometheus_group }}"
        mode: '0644'
        content: |
          global:
            scrape_interval: 15s
            evaluation_interval: 15s
            external_labels:
              monitor: 'prometheus-monitor'

          # Alertmanager configuration (optional)
          alerting:
            alertmanagers:
              - static_configs:
                  - targets: []

          # Load rules once and periodically evaluate them
          rule_files:
            # - "alerts.yml"

          # Scrape configurations
          scrape_configs:
            # Prometheus itself
            - job_name: 'prometheus'
              static_configs:
                - targets: ['localhost:9090']

            # Node Exporter
            - job_name: 'node_exporter'
              static_configs:
                - targets: ['localhost:9100']

    # ==========================================
    # Create Prometheus systemd service
    # ==========================================
    - name: Create Prometheus systemd service file
      copy:
        dest: /etc/systemd/system/prometheus.service
        mode: '0644'
        content: |
          [Unit]
          Description=Prometheus Monitoring System
          Documentation=https://prometheus.io/docs/introduction/overview/
          After=network-online.target
          Wants=network-online.target

          [Service]
          Type=simple
          User={{ prometheus_user }}
          Group={{ prometheus_group }}
          ExecReload=/bin/kill -HUP $MAINPID
          ExecStart=/usr/local/bin/prometheus \
            --config.file={{ prometheus_dir }}/prometheus.yml \
            --storage.tsdb.path={{ prometheus_data_dir }} \
            --web.console.templates={{ prometheus_dir }}/consoles \
            --web.console.libraries={{ prometheus_dir }}/console_libraries \
            --web.listen-address=0.0.0.0:9090 \
            --web.external-url=

          SyslogIdentifier=prometheus
          Restart=always
          RestartSec=5

          [Install]
          WantedBy=multi-user.target

    # ==========================================
    # Download and Install Node Exporter
    # ==========================================
    - name: Check if Node Exporter is already installed
      stat:
        path: /usr/local/bin/node_exporter
      register: node_exporter_binary

    - name: Download Node Exporter
      get_url:
        url: "https://github.com/prometheus/node_exporter/releases/download/v{{ node_exporter_version }}/node_exporter-{{ node_exporter_version }}.linux-amd64.tar.gz"
        dest: "/tmp/node_exporter-{{ node_exporter_version }}.linux-amd64.tar.gz"
        mode: '0644'
      when: not node_exporter_binary.stat.exists

    - name: Extract Node Exporter
      unarchive:
        src: "/tmp/node_exporter-{{ node_exporter_version }}.linux-amd64.tar.gz"
        dest: "/tmp"
        remote_src: yes
      when: not node_exporter_binary.stat.exists

    - name: Copy Node Exporter binary
      copy:
        src: "/tmp/node_exporter-{{ node_exporter_version }}.linux-amd64/node_exporter"
        dest: "/usr/local/bin/node_exporter"
        owner: "{{ node_exporter_user }}"
        group: "{{ node_exporter_group }}"
        mode: '0755'
        remote_src: yes
      when: not node_exporter_binary.stat.exists

    # ==========================================
    # Create Node Exporter systemd service
    # ==========================================
    - name: Create Node Exporter systemd service file
      copy:
        dest: /etc/systemd/system/node_exporter.service
        mode: '0644'
        content: |
          [Unit]
          Description=Node Exporter
          Documentation=https://prometheus.io/docs/guides/node-exporter/
          After=network-online.target
          Wants=network-online.target

          [Service]
          Type=simple
          User={{ node_exporter_user }}
          Group={{ node_exporter_group }}
          ExecStart=/usr/local/bin/node_exporter \
            --collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/) \
            --web.listen-address=0.0.0.0:9100

          SyslogIdentifier=node_exporter
          Restart=always
          RestartSec=5

          [Install]
          WantedBy=multi-user.target

    # ==========================================
    # Configure Firewall (if firewalld/ufw is active)
    # ==========================================
    - name: "[Debian/Ubuntu] Allow Prometheus port through UFW"
      community.general.ufw:
        rule: allow
        port: '9090'
        proto: tcp
      when: ansible_os_family == supported_debian_family
      ignore_errors: yes

    - name: "[Debian/Ubuntu] Allow Node Exporter port through UFW"
      community.general.ufw:
        rule: allow
        port: '9100'
        proto: tcp
      when: ansible_os_family == supported_debian_family
      ignore_errors: yes

    - name: "[RedHat] Allow Prometheus port through firewalld"
      firewalld:
        port: 9090/tcp
        permanent: yes
        state: enabled
        immediate: yes
      when: ansible_os_family == supported_redhat_family
      ignore_errors: yes

    - name: "[RedHat] Allow Node Exporter port through firewalld"
      firewalld:
        port: 9100/tcp
        permanent: yes
        state: enabled
        immediate: yes
      when: ansible_os_family == supported_redhat_family
      ignore_errors: yes

    # ==========================================
    # Start and Enable Services
    # ==========================================
    - name: Reload systemd daemon
      systemd:
        daemon_reload: yes

    - name: Enable and start Prometheus service
      systemd:
        name: prometheus
        state: started
        enabled: yes

    - name: Enable and start Node Exporter service
      systemd:
        name: node_exporter
        state: started
        enabled: yes

    # ==========================================
    # Cleanup temporary files
    # ==========================================
    - name: Clean up Prometheus temporary files
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - "/tmp/prometheus-{{ prometheus_version }}.linux-amd64.tar.gz"
        - "/tmp/prometheus-{{ prometheus_version }}.linux-amd64"
        - "/tmp/node_exporter-{{ node_exporter_version }}.linux-amd64.tar.gz"
        - "/tmp/node_exporter-{{ node_exporter_version }}.linux-amd64"

    # ==========================================
    # Verification
    # ==========================================
    - name: Wait for Prometheus to start
      wait_for:
        port: 9090
        delay: 5
        timeout: 30

    - name: Wait for Node Exporter to start
      wait_for:
        port: 9100
        delay: 5
        timeout: 30

    - name: Check Prometheus status
      systemd:
        name: prometheus
      register: prometheus_status

    - name: Check Node Exporter status
      systemd:
        name: node_exporter
      register: node_exporter_status

    - name: Verify Prometheus is responding
      uri:
        url: http://localhost:9090/-/healthy
        method: GET
        status_code: 200
      register: prometheus_health
      ignore_errors: yes

    - name: Verify Node Exporter is responding
      uri:
        url: http://localhost:9100/metrics
        method: GET
        status_code: 200
      register: node_exporter_health
      ignore_errors: yes

    - name: Display installation summary
      debug:
        msg:
          - "========================================="
          - "Hostname: {{ ansible_hostname }}"
          - "OS: {{ ansible_distribution }} {{ ansible_distribution_version }}"
          - "========================================="
          - "Prometheus Version: {{ prometheus_version }}"
          - "Prometheus Status: {{ prometheus_status.status.ActiveState }}"
          - "Prometheus URL: http://{{ ansible_default_ipv4.address }}:9090"
          - "Prometheus Health: {{ 'OK' if prometheus_health.status == 200 else 'FAILED' }}"
          - "========================================="
          - "Node Exporter Version: {{ node_exporter_version }}"
          - "Node Exporter Status: {{ node_exporter_status.status.ActiveState }}"
          - "Node Exporter URL: http://{{ ansible_default_ipv4.address }}:9100"
          - "Node Exporter Health: {{ 'OK' if node_exporter_health.status == 200 else 'FAILED' }}"
          - "========================================="
          - "Configuration file: {{ prometheus_dir }}/prometheus.yml"
          - "Data directory: {{ prometheus_data_dir }}"
          - "========================================="